{% extends 'store/main.html' %}
<!DOCTYPE html>
{% load static %}
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Checkout{% endblock %}</title>
</head>

<body>
    {% block content %}
    <div class="container-fluid mt-2">
        <div class="row">
            <div class="col-sm-6 box-element">
                <form id="form" class="fs-anton">
                    <hr>
                    <div id="user-info">
                        <p>User Info:</p>
                        <div class="form-field">
                            <input required class="form-control" type="text" name="name" placeholder="Name..">
                        </div>
                        <div class="form-field">
                            <input required class="form-control" type="email" name="email" placeholder="Email..">
                        </div>
                        <div class="form-field">
                            <input required class="form-control" type="text" name="phone" placeholder="Phone(optional)">
                        </div>
                    </div>

                    <div id="shipping-info">
                        <hr>
                        <p>Shipping Information:</p>
                        <i class="fs-anton">please enter specific details</i>
                        <hr>
                        <div class="form-field">
                            <input class="form-control" type="text" name="address" placeholder="Address..">
                        </div>
                        <div class="form-field">
                            <input class="form-control" type="text" name="city" placeholder="City..">
                        </div>
                        <div class="form-field">
                            <input class="form-control" type="text" name="state" placeholder="State..">
                        </div>
                        <div class="form-field">
                            <input class="form-control" type="text" name="zipcode" placeholder="Zip code..">
                        </div>
                    </div>
                    <input id="form-button"
                        class="m-2 bg-site-green text-white td-none px-5 py-2 border border-0 fw-bold" type="submit"
                        value="Submit">
                    <p class="fs-anton">we will contact you as soon as your order is placed</p>
                </form>

                <div class="box-element m-2 p-3" id="payment-info">
                    <p class="fs-anton text-center">We Accept Paypal Options</p>
                    <!-- <button id="make-payment">Make payment</button> -->
                    <div id="paypal-button-container"></div>
                </div>
            </div>

            <div class="col-sm-4">
                <h3 class="fs-anton">Your Order</h3>
                {% for item in items %}
                <div class="row mb-1">
                    <div class="col-sm-12">
                        <div class="d-flex">
                            <img class="row-image" src="{{item.product.imageURL}}">
                            <div class="mx-2 text-start">
                                <p class="fs-anton fw-bold">{{item.product.name}}</p>
                                <p class="fs-anton">&#8358;{{item.product.price|floatformat:2}}</p>
                                <p class="quantity fs-roboto ">x{{item.quantity}}</p>
                                <p class="fs-roboto fw-bold">&#8358;{{item.get_total|floatformat:2}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <script
        src="https://www.paypal.com/sdk/js?client-id=Aaft7QNk7Qt2Js9ylqCjYB_dP3fnWj_uAwvvjPXuV_nRn8JJIcZDoArjqok1XzkCs9Kkc-z7E2UNOtLJ&currency=USD&disable-funding=credit&debug=true&integration-date=2023-12-18&intent=authorize&vault=true"></script>
    <!-- script for rendering paypal buttons -->
    <script type="text/javascript">
        var total = '{{order.get_cart_total}}'
        // Render the PayPal button into #paypal-button-container
        paypal.Buttons({

            style: {
                color: 'gold',
                shape: 'rect',
            },

            // Set up the transaction
            createOrder: function (data, actions) {
                return actions.order.create({
                    purchase_units: [{
                        amount: {
                            value: parseFloat(total).toFixed(2)
                        }
                    }]
                });
            },

            // Finalize the transaction
            onApprove: function (data, actions) {
                return actions.order.capture().then(function (details) {
                    // Show a success message to the buyer
                    alert("Transaction completed by " + details.payer.name.given_name + '!');
                    submitFormData()
                });
            }

        }).render('#paypal-button-container');
    </script>

    <script type="text/javascript">
        // get the user info form element
        var form = document.getElementById('form');
        form.addEventListener('submit', function (e) {
            // prevent the form from submitting
            e.preventDefault()
            console.log('Form Submitted...')
            // call the method that sends user data to the database
            submitFormData();
        })

        /*
        document.getElementById('make-payment').addEventListener('click', function (e) {
            submitFormData()
        })*/


        function submitFormData() {
            console.log('Payment button clicked')

            var userFormData = {
                'name': null,
                'email': null,
                'total': total,
                'phone': null
            }

            var shippingInfo = {
                'address': null,
                'city': null,
                'state': null,
                'zipcode': null,
            }

            // user shipping info data
            shippingInfo.address = form.address.value
            shippingInfo.city = form.city.value
            shippingInfo.state = form.state.value
            shippingInfo.zipcode = form.zipcode.value

            // user name and contact details
            userFormData.name = form.name.value
            userFormData.email = form.email.value
            userFormData.phone = form.phone.value


            console.log('Shipping Info:', shippingInfo)
            console.log('User Info:', userFormData)

            var url = "/process_order/"
            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken,
                },
                // convert user info and shipping info to json to send to backend
                body: JSON.stringify({ 'form': userFormData, 'shipping': shippingInfo }),

            })
                .then((response) => response.json())
                .then((data) => {
                    console.log('Success:', data);
                    alert('Transaction completed');

                    // create cart and send to cookies
                    cart = {};
                    document.cookie = 'cart=' + JSON.stringify(cart) + ";domain=;path=/";

                    // reload page
                    window.location.href = "{% url 'store' %}";

                })
        }
    </script>
    {% endblock content %}
</body>